---
- name: Install certbot
  community.general.snap:
    name: certbot
    classic: yes
- name: Check if certificate already exists.
  stat:
    path: /etc/letsencrypt/live/{{ item }}/cert.pem
  register: letsencrypt_cert
  with_items: "{{ ssl_domains }}"
- name: Stop services to allow certbot to generate a cert.
  service:
    name: nginx
    state: stopped
- name: Generate new certificate if one doesn't exist.
  shell: "certbot certonly --standalone --noninteractive --agree-tos --email {{ my_email }} -d {{ item.item }}"
  with_items: "{{ letsencrypt_cert.results }}"
  when: item.stat.exists == False
- name: Start services after cert has been generated.
  service:
    name: nginx
    state: started